"""Классификация типа кризиса по правилам (пороги коэффициентов)."""

CRISIS_TYPES = {
    "stagnation": "Кризис стагнации (падение рентабельности)",
    "growth": "Кризис роста / «стеклянный потолок»",
    "technical_bankruptcy": "Кризис иллюзии обмана (техническое банкротство)",
    "bankruptcy": "Фактическое банкротство",
    "aging": "Кризис старения",
}


def classify_crisis(
    current_ratio: float,
    quick_ratio: float,
    absolute_liquidity: float,
    autonomy: float,
    profit_margin: float,
    cash: float,
    short_term_liabilities: float,
) -> tuple[str, float, str]:
    """
    Возвращает (code, confidence, reasoning).
    Упрощённые правила по ТЗ.
    """
    reasons = []

    # Фактическое банкротство: нет денег и высокие краткосрочные обязательства
    if short_term_liabilities > 0 and cash <= 0 and current_ratio < 0.5:
        return (
            "bankruptcy",
            0.85,
            "Отсутствие денежных средств при значимых краткосрочных обязательствах и низкой текущей ликвидности указывает на фактическое банкротство.",
        )

    # Техническое банкротство: плохая ликвидность, но активы есть
    if current_ratio < 1.0 and absolute_liquidity < 0.2:
        reasons.append("текущая ликвидность ниже 1, абсолютная ликвидность низкая")
    if short_term_liabilities > 0 and cash < short_term_liabilities * 0.1:
        reasons.append("денежных средств недостаточно для покрытия срочных обязательств")
    if reasons:
        return (
            "technical_bankruptcy",
            0.75,
            "Риск потери платёжеспособности: " + "; ".join(reasons) + ".",
        )

    # Стагнация: низкая рентабельность при приемлемой ликвидности
    if profit_margin < 0.05 and current_ratio >= 1.0:
        return (
            "stagnation",
            0.7,
            "Низкая рентабельность продаж при сохранении платёжеспособности характерна для кризиса стагнации.",
        )
    if profit_margin < 0 and autonomy > 0.3:
        return (
            "stagnation",
            0.65,
            "Убыточность при сохранении доли собственного капитала указывает на кризис стагнации.",
        )

    # Кризис роста: высокая долговая нагрузка при положительной рентабельности
    if autonomy < 0.4 and profit_margin > 0.05:
        return (
            "growth",
            0.6,
            "Низкая автономия при положительной рентабельности может указывать на ограничения масштабирования («стеклянный потолок»).",
        )

    # Кризис старения: средние показатели без явных острых проблем
    if current_ratio >= 1.0 and profit_margin >= 0 and autonomy >= 0.3:
        return (
            "aging",
            0.5,
            "Показатели в норме; возможен кризис старения или стабильное состояние — требуется дополнительный анализ динамики.",
        )

    # По умолчанию — стагнация с низкой уверенностью
    return (
        "stagnation",
        0.45,
        "По введённым показателям однозначная классификация затруднена. Рекомендуется уточнить данные и просмотреть динамику за несколько периодов.",
    )
