# Веб-сервис «Антикризисное управление»

Проект расположен **целиком в этой папке** (`2_feb`). Никакие другие папки не изменяются.

## Быстрый старт (локально)

**Терминал 1 — бэкенд** (из корня проекта):
```bash
source activate.sh
cd backend && uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**Терминал 2 — фронтенд** (из корня проекта):
```bash
npm run dev:frontend
```

В браузере откройте адрес, который выведет Vite (обычно **http://localhost:5173**). Если порт занят, будет выведен другой (5174, 5175 и т.д.).

Соответствует ТЗ: веб-сервис для бизнесменов по подписке с модулем антикризисного управления (баланс, БДР, БДДС, коэффициенты, классификация типа кризиса по правилам, планы мероприятий).

## Структура

- **backend/** — API на FastAPI (Python), SQLite, JWT-авторизация, расчёт коэффициентов и классификация кризиса по правилам.
- **frontend/** — SPA на React (TypeScript, Vite), дашборд, ввод отчётности, планы мероприятий.
- **ТЗ_веб-сервис_антикризисное_управление.md** — техническое задание.
- **ПРОМПТ_для_составления_ТЗ_веб-сервиса.md** — промпт для ТЗ.
- **Расчётная модель (Excel → код):** в веб-сервисе есть модуль «Расчётная модель» (меню и страница `/calc`). Модель загружается из JSON-экспорта книги Excel.
- **Дашборд аналитики:** по организации и периоду — визуализация баланса, БДР, БДДС, коэффициентов и карты кризиса (графики Recharts) и выгрузка всех данных в JSON или CSV (`/orgs/:id/analytics`).
- **Финансовая модель (программный расчёт):** модуль `backend/app/services/fin_model.py` считает по данным периода (баланс, БДР, БДДС) показатели: прибыль, маржа, ТБУ (выручка безубыточности), денежные потоки. Входы — только таблицы заполнения; результаты отдаются в расчётной таблице, дашборде аналитики и в выгрузке. Маппинг полей Excel → API описан в `backend/app/calc_model/input_mapping.json`. Чтобы перевести свою рабочую тетрадь в расчётный модуль, экспортируйте книгу в JSON (все листы и формулы), затем положите результат в `backend/app/calc_model/exported/`.

## Экспорт Excel в расчётный модуль

Файл `.xlsx` — это ZIP с XML; формулы и все листы (включая скрытые) можно выгрузить в JSON и использовать в коде.

1. **Установите openpyxl** (уже в `backend/requirements.txt`).
2. **Запустите скрипт** из корня проекта (файл `Рабочая тетрадь_Фин модель.xlsx` положите в корень или укажите путь):

   ```bash
   source .venv/bin/activate   # или source activate.sh
   python backend/scripts/export_excel_to_json.py "Рабочая тетрадь_Фин модель.xlsx"
   ```

   Результат появится в `backend/app/calc_model/exported/`: `_workbook.json` и по одному JSON на каждый лист (имя листа → безопасное имя файла).
3. В веб-сервисе откройте **Расчётная модель**: задайте входные ячейки (например B2, B3), нажмите «Рассчитать» — по формулам из экспорта посчитаются все зависимые ячейки.

Поддерживаются формулы: ссылки на ячейки (A1, Лист1!B2), диапазоны (A1:A10), функции SUM, AVERAGE, арифметика + − * /.

## Единое окружение (одна папка — корень проекта)

Все зависимости собраны в корне проекта: Python — в `.venv/`, Node — в `node_modules/` (через npm workspaces). Активация одной командой.

### Одна команда активации (macOS / Linux)

Из корня проекта:

```bash
source activate.sh
```

или

```bash
. activate.sh
```

Скрипт при первом запуске создаёт `.venv`, ставит зависимости бэкенда (`backend/requirements.txt`), активирует окружение и выставляет `PYTHONPATH` для запуска бэкенда из корня.

### Ручная настройка (если не используете activate.sh)

**1. Виртуальное окружение Python (в корне):**

```bash
# из корня проекта (2_feb)
uv venv --python 3.12
source .venv/bin/activate
uv pip install -r backend/requirements.txt
```

**2. Зависимости фронтенда (из корня):**

```bash
npm install
```

Устанавливаются в `frontend/node_modules/` (workspace). Окружение готово.

**Активация в следующий раз** — только активировать venv:

- **macOS / Linux:** `source .venv/bin/activate`
- **Windows (cmd):** `.venv\Scripts\activate.bat`
- **Windows (PowerShell):** `.venv\Scripts\Activate.ps1`

Деактивация: `deactivate`.

## Запуск

### Вариант A: Docker (рекомендуется)

Из корня проекта:

```bash
docker compose up --build
```

- Фронтенд: http://localhost (порт 80)
- Бэкенд API: http://localhost:8000
- Документация API: http://localhost:8000/docs

Данные БД сохраняются в volume `backend_data`.

**Развёртывание в облаке (Timeweb Cloud и др.):**  
Чтобы отображался веб-сервис, а не страница «Welcome to nginx», нужно запускать **наш образ**, собранный из корня репозитория:

1. **Сборка из репозитория:** в настройках деплоя укажите, что образ собирается из **корня** репозитория (не из подпапки), по **Dockerfile в корне**.
2. **Порт контейнера:** контейнер слушает порт **80**. В настройках сервиса должен быть указан порт 80 (или маршрутизация 80 → контейнер:80).
3. **Пересборка после пуша:** после исправлений в коде выполните пересборку и перезапуск контейнера на платформе.
4. **Регистрация/вход:** в образе пароли хешируются через `bcrypt` (без passlib). Если фронт и API отдаются с одного домена (как в нашем Docker), CORS не мешает. Если фронт на другом домене — задайте переменную окружения `CORS_ORIGINS=https://ваш-домен` (через запятую несколько).

Локальная проверка образа:
```bash
docker build -t anticrisis .
docker run -p 80:80 anticrisis
```
Откройте http://localhost — должна открыться страница входа веб-сервиса, а не «Welcome to nginx». API доступен по пути `/api/`.

### Вариант B: Локально (с uv)

#### 1. Бэкенд

```bash
cd backend
uv venv --python 3.12
source .venv/bin/activate   # Windows: .venv\Scripts\activate
uv pip install -r requirements.txt
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

Или из каталога `backend` без активации: `uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`

API: http://127.0.0.1:8000
Документация: http://127.0.0.1:8000/docs

### 2. Фронтенд

```bash
cd frontend
npm install
npm run dev
```

Откройте http://localhost:5173

Фронтенд ходит на бэкенд через прокси `/api` → `http://127.0.0.1:8000` (настроено в `frontend/vite.config.ts`).

## Сценарий использования

1. **Регистрация** → **Вход**.
2. **Организации** → создать организацию.
3. **Дашборд** → выбрать организацию → перейти в «Отчётность и коэффициенты».
4. Добавить **период**, ввести данные **Баланса** и **БДР** (и при необходимости БДДС), сохранить.
5. Посмотреть **коэффициенты** и **карту кризиса** (тип кризиса по правилам).
6. **Планы мероприятий** → создать план (привязка к типу кризиса), отмечать выполнение пунктов чек-листа.

## Технологии

- **Backend:** FastAPI, SQLAlchemy 2 (async), SQLite (aiosqlite), JWT, Pydantic.
- **Frontend:** React 18, React Router, TypeScript, Vite.
- **Расчёты:** ликвидность (текущая, быстрая, абсолютная), автономия, долг/капитал, ROA, ROE, рентабельность продаж.
- **Классификация кризиса:** правила по порогам (стагнация, рост, техническое банкротство, фактическое банкротство, старение).

Все файлы проекта лежат только в этой папке.

## Git: как залить проект в репозиторий

Репозиторий инициализирован в этой папке. В `.gitignore` добавлены:

- **Презентации и рабочие тетради:** `*.pdf`, `*.pptx`, `*.ppt`, `*.xlsx`, `*.xls`, `*.ipynb`, `*.doc`, `*.docx`
- **Среда и артефакты:** `venv/`, `node_modules/`, `__pycache__/`, `dist/`, `*.db`, `.env`
- **IDE и OS:** `.idea/`, `.vscode/`, `.DS_Store`

### Первый коммит и пуш в GitHub

1. Добавить файлы и сделать коммит:

```bash
git add .
git status   # проверьте, что в индекс не попали .pdf, .xlsx и т.п.
git commit -m "Initial: веб-сервис антикризисное управление, Docker"
```

2. Связать проект с удалённым репозиторием (если ещё не добавлен remote):

```bash
git remote add origin https://github.com/AIhexNICK-MAIL-RU/anticrysis.git
```

Если `origin` уже есть с другим URL — заменить:`git remote set-url origin https://github.com/AIhexNICK-MAIL-RU/anticrysis.git`

3. Загрузить код в GitHub:

```bash
git push -u origin master
```

Git запросит логин и пароль (или токен). Если в репозитории на GitHub уже есть другие коммиты и push отклонится — выполнить:

```bash
git push -u origin master --force-with-lease
```

Для работы по SSH:

```bash
git remote set-url origin git@github.com:AIhexNICK-MAIL-RU/anticrysis.git
git push -u origin master
```
